<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel – Gallery</title>
  <!-- AdminLTE + Bootstrap CSS -->
  <link rel="stylesheet" href="../admin/plugins/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="../admin/dist/css/adminlte.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">

  <!-- Навбар -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="/" class="nav-link">Main Page</a>
      </li>
      <a href="/admin/logout" class="btn btn-danger btn-sm ml-3">Logout</a>
    </ul>
  </nav>

  <!-- Боковое меню -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="#" class="brand-link">
      <span class="brand-text font-weight-light">Construction Admin</span>
    </a>
    <div class="sidebar">
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column">
          <li class="nav-item">
            <a href="/admin/index.html" class="nav-link">
              <i class="nav-icon fas fa-file-pdf"></i>
              <p>PDF-Files</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="/admin/projects.html" class="nav-link">
              <i class="nav-icon fas fa-project-diagram"></i>
              <p>Projects</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="/admin/gallery.html" class="nav-link active">
              <i class="nav-icon fas fa-image"></i>
              <p>Gallery</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="/admin/vacancy.html" class="nav-link ">
              <i class="nav-icon fas fa-handshake"></i>
              <p>Vacancy</p>
            </a>
          </li>          
          <li class="nav-item">
            <a href="#" class="nav-link">
              <i class="nav-icon fas fa-users"></i>
              <p>Users</p>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </aside>

  <!-- Контент -->
  <div class="content-wrapper">
    <div class="content-header">
      <h1 class="m-3">Gallery</h1>
    </div>
    <div class="content">
      <div class="container-fluid">
        <!-- Таблица элементов галереи -->
        <h3>Gallery Items</h3>
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Type</th>
              <th>Preview</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="galleryTableBody">
            <!-- Данные подгружаются JS -->
          </tbody>
        </table>

        <hr>
        <h4>Add New Item</h4>
        <form id="addGalleryForm" action="/admin/gallery/upload" method="POST" enctype="multipart/form-data">
          <div class="form-group">
            <label>Type:</label>
            <select name="type" id="addTypeSelect" class="form-control">
              <option value="photo">Photo</option>
              <option value="video">Video</option>
            </select>
          </div>
          <div class="form-group" id="addFileGroup">
            <label>File (Image or Video):</label>
            <input type="file" name="file" id="addFileInput" accept="image/*,video/*" class="form-control">
          </div>
          
          <div class="form-group">
            <label>Title:</label>
            <input type="text" name="title" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-primary">Add Item</button>
        </form>
      </div>
    </div>
  </div>

  <footer class="main-footer text-center">
    <strong>Construction © 2025</strong>
  </footer>
</div>

<!-- Edit Gallery Modal -->
<div class="modal fade" id="editGalleryModal" tabindex="-1" role="dialog" aria-labelledby="editGalleryLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <form id="editGalleryForm" enctype="multipart/form-data">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editGalleryLabel">Edit Item</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id" id="editId">

          <div class="form-group">
            <label for="editType">Type</label>
            <select id="editType" name="type" class="form-control">
              <option value="photo">Photo</option>
              <option value="video">Video</option>
            </select>
          </div>
          <div class="form-group" id="editFileGroup">
            <label for="editFile">File (new)</label>
            <input type="file" id="editFile" name="file"  accept="image/*,video/*" class="form-control">
            <small id="currentFilePreview" class="form-text text-muted"></small>
          </div>
          <!-- <div class="form-group" id="editUrlGroup" style="display: none;">
            <label for="editUrl">Video URL (YouTube embed)</label>
            <input type="text" id="editUrl" name="videoUrl" class="form-control" placeholder="https://www.youtube.com/embed/...">
          </div> -->
          <div class="form-group">
            <label for="editTitle">Title</label>
            <input type="text" id="editTitle" name="title" class="form-control" required>
          </div>

          <div class="form-group">
            <label for="editTitleEn">Title (EN)</label>
            <input type="text" id="editTitleEn" name="title_en" class="form-control">
        </div>

         <div class="form-group">
            <label for="editTitleRu">Title (RU)</label>
            <input type="text" id="editTitleRu" name="title_ru" class="form-control">
        </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Скрипты AdminLTE и собственный JS -->
<script src="../admin/plugins/jquery/jquery.min.js"></script>
<script src="../admin/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="../admin/dist/js/adminlte.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  loadGalleryItems();

  // Переключение между File и URL при добавлении
  $('#addTypeSelect').change(function() {
    const val = $(this).val();
    if (val === 'photo') {
      $('#addFileGroup').show();
      $('#addUrlGroup').hide();
    } else {
      $('#addFileGroup').show();
      $('#addUrlGroup').show();
    }
  });

  // Переключение между File и URL при редактировании
  $('#editType').change(function() {
    const val = $(this).val();
    if (val === 'photo') {
      $('#editFileGroup').show();
      $('#editUrlGroup').hide();
    } else {
      $('#editFileGroup').show();
      $('#editUrlGroup').show();
    }
  });

  // Обработчик сабмита формы редактирования
  $('#editGalleryForm').submit(async function(e) {
    e.preventDefault();
    const form = e.currentTarget;
    const id = form.id.value;
    const formData = new FormData(form);

    try {
      const resp = await fetch(`/admin/gallery/${id}`, {
        method: 'PUT',
        body: formData
      });
      if (!resp.ok) throw new Error(resp.status);
      console.log('успешно обновлено, закрываю модалку');
      $('#editGalleryModal').modal('hide');
      setTimeout(() => loadGalleryItems(), 0);
    } catch (err) {
      console.error('Ошибка при сохранении элемента:', err);
    }
  });
});

// Загрузка списка элементов и рендер в таблицу
async function loadGalleryItems() {
  try {
    const resp = await fetch('/admin/gallery/all', {
      headers: { 'Accept': 'application/json' }
    });
    if (!resp.ok) throw new Error(`Status ${resp.status}`);
    const items = await resp.json();

    const tbody = document.getElementById('galleryTableBody');
    tbody.innerHTML = '';

    items.forEach(item => {
      const tr = document.createElement('tr');
      let previewHtml = '';
      if (item.type === 'photo') {
          previewHtml = `<img src="${item.filepath}" style="max-height:150px;">`;
        } else {
          previewHtml = `
            <video style="max-height:150px; max-width:200px;" controls>
              <source src="${item.filepath}" type="video/mp4">
              Ваш браузер не поддерживает видео.
            </video>
          `;
        }

      tr.innerHTML = `
        <td>${item.id}</td>
        <td>${escapeHtml(item.title)}</td>
        <td>${item.type}</td>
        <td>${previewHtml}</td>
        <td>
          <button class="btn btn-sm btn-info" onclick="onEdit(${item.id})">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="onDelete(${item.id})">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error('Не удалось загрузить галерею:', err);
  }
}

async function onEdit(id) {
  try {
    const resp = await fetch(`/admin/gallery/${id}`, { headers: { 'Accept': 'application/json' } });
    if (!resp.ok) throw new Error(resp.status);
    const item = await resp.json();

    // Заполняем скрытый id, title и type
    document.getElementById('editId').value = item.id;
    document.getElementById('editTitle').value = item.title;
    document.getElementById('editTitleEn').value = item.translations?.en || '';
    document.getElementById('editTitleRu').value = item.translations?.ru || '';
    document.getElementById('editType').value = item.type;

    // Элемент, куда показываем текущее превью
    const preview = document.getElementById('currentFilePreview');

    if (item.type === 'photo') {
      // При фото скрываем видеоблоки (если нужно) и показываем превью картинки
      $('#editFileGroup').show();
      preview.innerHTML = item.filepath
        ? `<img src="${item.filepath}" style="max-height:150px;"> Текущее изображение`
        : 'Изображение не задано';
    } else {
      // При видео показываем превью локального видео
      $('#editFileGroup').show();
      preview.innerHTML = item.filepath
        ? `<video src="${item.filepath}" style="max-height:150px; max-width:200px;" controls>Ваш браузер не поддерживает видео.</video> Текущее видео`
        : 'Видео не задано';
    }

    // После заполнения полей показываем модалку
    $('#editGalleryModal').modal('show');
  } catch (e) {
    console.error('Не удалось загрузить элемент для редактирования:', e);
  }
}

// Удаление элемента
async function onDelete(id) {
  if (!confirm('Удалить элемент #' + id + '?')) return;
  try {
    const resp = await fetch(`/admin/gallery/${id}`, { method: 'DELETE' });
    if (!resp.ok) throw new Error(`Status ${resp.status}`);
    loadGalleryItems();
  } catch (err) {
    console.error('Ошибка удаления:', err);
  }
}

// Функция экранирования текста
function escapeHtml(str) {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

// При отправке формы добавления, динамически показываем/скрываем поля
document.getElementById('addTypeSelect').addEventListener('change', function() {
  const val = this.value;
  if (val === 'photo') {
    document.getElementById('addFileGroup').style.display = 'block';
    document.getElementById('addUrlGroup').style.display = 'none';
  } else {
    document.getElementById('addFileGroup').style.display = 'block';
    document.getElementById('addUrlGroup').style.display = 'block';
  }
});

// Устанавливаем изначальное состояние для Add формы
document.addEventListener('DOMContentLoaded', () => {
  const initialType = document.getElementById('addTypeSelect').value;
  if (initialType === 'photo') {
    document.getElementById('addUrlGroup').style.display = 'none';
  } else {
    document.getElementById('addUrlGroup').style.display = 'block';
  }
});
</script>
</body>
</html>
